From 4b89dc935259fef27d0e1cfd5ae8898799f1692b Mon Sep 17 00:00:00 2001
From: Stuart Yoder <stuart.yoder@arm.com>
Date: Mon, 19 Jul 2021 10:05:24 -0500
Subject: [PATCH 20/37] security-extension: updates to image generation

-add unsigned Application1..efi Application2.efi and Application3.efi images from
 the ImageLoad test
-generate images 4-9

Signed-off-by: Stuart Yoder <stuart.yoder@arm.com>
---
 .../Dependency/Keys/Application1.efi          | Bin 0 -> 12288 bytes
 .../Dependency/Keys/Application2.efi          | Bin 12288 -> 12288 bytes
 .../Dependency/Keys/Application3.efi          | Bin 0 -> 12288 bytes
 .../BlackBoxTest/Dependency/Keys/GNUmakefile  |  65 ++++++++++++------
 4 files changed, 45 insertions(+), 20 deletions(-)
 create mode 100644 uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application1.efi
 create mode 100644 uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application3.efi

diff --git a/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application1.efi b/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application1.efi
new file mode 100644
index 0000000000000000000000000000000000000000..98c37913477c6cffbe7710351b251f8e3bf66121
GIT binary patch
literal 12288
zcmeI0Pe>F|9LImNV;w3&(x5<UTmw(;TO$qW(A!;2h5m@!QgqoJXP!Fjy0h%ehT<VZ
z!b_Khpi74pBU(=$il7edCAxdCYf?nVAdKEY?Duvx#x8<IQ2ZXe`Tcp{-|xNmncKT^
z3-&#39^H2-6%qj=Km>>Y5g-CYfCvx)B0vO)z<)wuWB|Zk4(+<l7l^=Nm1^FeXrckX
zF8(#HCzTMVTElUuVfOrP%lFg;1(ywgwqW8n{fIB7ebr;<UOP6>*8s>wY|}S)beO2?
zl?@CIPz!{A#MJ;+!bYqwq(M&@=0?MY)~9lY0aA-{iJPowZGd)ewWg=nHfLW|@fWUa
z>QMfg)T%A$Z?u3sj+VEARBIhr7dz4LD_eT?y{;`MnnAwq1o?4m>tW^;mpb+f;eLxD
zC^vB~D<7ad2N%~eP2XRr^;YcjAP(inx>jE5(8{P?J@AOjb-i_&V_gNcTx)3WVcgW{
zx2o0;-sf^@K2ZhWvWB`!hqCZ&v6IWYXie<jeuhg!?T5bVt<Iqj;W<uonZdle@7H9k
zy3xYr=IooNH9d_v8bp8y5CI}U1c(3;AOb{y2oM1xKm`6x0=-X84la1-`SW7r&b!ao
z*2hy9-qz;7@x_;)!pGW;h5g=2J@XvFhlEL^F|WqEqrqNm(w!2_^Gh?X9qnc}++voE
zjd{hiX?f`};hW48R;lRtGhO(ABJ!T&=9y;|or3Q%VQ0^F`NH#ANsK#Pp5?Q6$;sI)
zg<%q-{(*REFg=(^^srcLG%?hBj$wKvJHf7FRl@WHOATBaW@^S=*H4P#ZO0NG8=f*J
z#Lp<6Gp%ggomNGxUlc^%7I|xi#R`R-W0^jlse5-&-*|VIbWk0!bGaY}@`(TuAOb{y
W2oM1xKm>>Y5g-CYfC&5*0zUvid*&Yi

literal 0
HcmV?d00001

diff --git a/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application2.efi b/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application2.efi
index 55456c913985d02f9e1fea5a9b46d0d1d890b44d..bf71b43a441190b8e8cc92bcc3658cd4630b1216 100644
GIT binary patch
delta 160
zcmZojXh_)5z{kiixsk7*QDU+n|9cfC28Im|EDS#xfHWfqgjO_g_{qosVmDkmz#M;V
zv!UR5zKsEfjJ!bA3_L(769piiT&iFyRGgYzT9jE*she6+lA2eXnV&a#okEzDQ+|F)
kaB5LmW^!t=zGrS?dMb=JSwhj04@D$?bB5v!zKH>r0P7Pn-2eap

delta 460
zcmZojXh_)5z{hAXxsk7*F=nzL|NDAI28Inv367Rbj0~nq3=Kg_35=E?F$E2VpNs|$
zKN)~*MimAi-EipubNscx)q7SxW@cFRfSGX>NZns%hKZkp8CMDe*<Xbjek#iV^#R#T
zK)nhI5cYm)hM!6j3_qX#|35uJ%>gXG=rO}YMFxiYi7Y-2KOZnNuWDehzqWw+$MyyC
zKucwSnwc54Ffus&6a^Y40>mJV_ACq^8JQVESR5RFE_7m;$P9E86VTBM4l_&y=?AF+
z@-KnqJRE*5kaqZ)fF$171k{5h&cLA8aOrcf<I1nX4nO}^A6WtNp*;t~$Af?WhrkR6
zX#!dJ{QrOP&4vP3_zV^rN=GM6y(HLY&#>TRW|8%_nZZF{-9Ea`E)cJtKE?OZ;rvzC
zB*L{kc5z)VtNpg;?L<clUM65bG6DmpLIH>;8!DKxI5`CeO|DP~6A38FFUe2N&(ZhE
dPfSTo@ytz3Po4Zi!BQNFACJV|tgkqO4*>sDsf7Rl

diff --git a/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application3.efi b/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/Application3.efi
new file mode 100644
index 0000000000000000000000000000000000000000..eab4ea5a40c27f5dfd02b95aad64de8882aaffbe
GIT binary patch
literal 12288
zcmeI0Pe>F|9LImNqa7-u(4d3RrjiosTQdVeXlB>Hhe9+-Bv{9pr!BkgE<3ZO*kLWY
zb!bB9(qTn|cDon^9y(+}bO<^u<)Mp4c#S}$h7kL`-8Du#2<l0GZ+P>2zxVsT-}}AK
z%;{Ynggv)`6MJ4t3yA;`AOb{y2oM1xKm>>Y5g-CY;E)jLX$LT}o^7Z32@P;eOr0!t
zG_9_2UcA%KPvXmmUBs{*Etp;3Mft8ex4`fMRJbShIc~7{xFvFIoomaw@_GS=8Vt?S
zwsbg=*9+@v3c#YvJ&>UUFkhKcTZScQu7p%?WlCxha~_}Kc<aE)$E(rSDGqKpFVzCt
zRBllYE^SP{&fw>q-;lvx>yt8NI9@LU=QLWS0vr*m!aU_@Rd2yhZ_1e!S;_{^fHUm}
z`%Miv%bS}|hR!RFjCnm+!;A;)5=C*+-@#77l_e3IlO=n$O0qGY`zDuXOP?x^g4#63
z73uea&^$oDq>v-8Ir30(X72|w0E)ASx^$JW@M@+;ai-8}xaM3np0l`z*jMBi^^2OP
z?}06MVI5}`XQ-$t)|it}hv$7{K0acXL<*Xe*y94$igk+`h4vlRREq3Y<g#pfXI%O}
zzFwv{Ykex#oXTxXzJI<b2bWZc;}d}p=%9gxHU?2>f&h9Ed^i}O!U#q<B%mF}QIY@W
z4&)D^Bt(D+5CI}U1c(3;AOb{y2oM1xa2N=@OmzMD{OoS`{HQum+kEra+LzqQpQ#re
zbEoW2%d6}DuY+x^s|#s0d*|barttdP{hnD|{~X6lg_O6@ulXB&?wssaY>YG0N>0QK
zUn9E_ON80*u$c&Ix)~himc~r3CleuSq8=|+c+?EVqRiA2p}1u-ZiFw^Timo*l8=Py
zP2FPtWGG^=esufLYisxScLqBHfo7(vy@9UFml#g>gh$zRTouqv&idOsx|!(ySj_6<
ziQ6Hao2+|G8|D8ze?-&6{@A!!#M*eAM-3j;Czu+KM?$)0VNFfjo&3hzvjpAh1|t%2
fW1uk+AOb{y2oM1xKm>>Y5g-CYfCvzQ110bmb#W{t

literal 0
HcmV?d00001

diff --git a/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/GNUmakefile b/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/GNUmakefile
index ded66458..8942221d 100644
--- a/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/GNUmakefile
+++ b/uefi-sct/SctPkg/TestCase/UEFI/EFI/RuntimeServices/SecureBoot/BlackBoxTest/Dependency/Keys/GNUmakefile
@@ -48,21 +48,46 @@ TEST_PK1_CRT=$(BIN_DIR)/SecureBoot_TestPK1.crt
 TEST_PK1_KEY=$(BIN_DIR)/SecureBoot_TestPK1.key
 endif
 
-all: $(TEST_KEYS) TestKEK2 KEKSigList1.auth TestImage1.bin TestImage2.bin TestImage3.bin NullKEK.auth NullDB.auth NullDBX.auth TestKEK1.auth TestDB1.auth TestDBX1.auth SignCert1 dbSigList1.auth SignCert2 SignCert3 RevokedCert1 RevokedCert2 RevokedCert3 RevokedCert4 dbSigList2.auth dbSigList3.auth dbSigList4.auth DBXRevokedList1.auth
+all: $(TEST_KEYS) TestKEK2 KEKSigList1.auth TestImage1.bin TestImage2.bin TestImage3.bin TestImage4.bin TestImage5.bin TestImage6.bin TestImage7.bin TestImage8.bin TestImage9.bin TestImage10.bin NullKEK.auth NullDB.auth NullDBX.auth TestKEK1.auth TestDB1.auth TestDBX1.auth SignCert1 dbSigList1.auth SignCert2 SignCert3 SignCert4 RevokedCert1 RevokedCert2 RevokedCert3 RevokedCert4 dbSigList2.auth dbSigList3.auth dbSigList4.auth DBXRevokedList1.auth
 
 TestImage1.bin:
-	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	cp $(SOURCE_DIR)/Application1.efi $(TARGET)_$(@)
 
 TestImage2.bin: SignCert1
-	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	cp $(SOURCE_DIR)/Application1.efi $(TARGET)_$(@)
 	sbsign --key $(TARGET)_SignCert1.key --cert $(TARGET)_SignCert1.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
 
 TestImage3.bin: SignCert2
 	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
 	sbsign --key $(TARGET)_SignCert2.key --cert $(TARGET)_SignCert2.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
 
+TestImage4.bin: SignCert3
+	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	sbsign --key $(TARGET)_SignCert3.key --cert $(TARGET)_SignCert3.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
+
 TestImage5.bin:
-	cp $(BIN_DIR)/Ebc_EbcDriver.efi $(TARGET)_$(@)
+	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+
+TestImage6.bin: RevokedCert1
+	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	sbsign --key $(TARGET)_RevokedCert1.key --cert $(TARGET)_RevokedCert1.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
+
+TestImage7.bin: RevokedCert2
+	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	sbsign --key $(TARGET)_RevokedCert2.key --cert $(TARGET)_RevokedCert2.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
+
+TestImage8.bin: RevokedCert3
+	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	sbsign --key $(TARGET)_RevokedCert3.key --cert $(TARGET)_RevokedCert3.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
+
+TestImage9.bin: RevokedCert4
+	cp $(SOURCE_DIR)/Application2.efi $(TARGET)_$(@)
+	sbsign --key $(TARGET)_RevokedCert4.key --cert $(TARGET)_RevokedCert4.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
+
+TestImage10.bin: SignCert3
+	cp $(SOURCE_DIR)/Application3.efi $(TARGET)_Unsigned_$(@)
+	cp $(SOURCE_DIR)/Application3.efi $(TARGET)_$(@)
+	sbsign --key $(TARGET)_SignCert3.key --cert $(TARGET)_SignCert3.crt $(TARGET)_$(@) --output $(TARGET)_$(@)
 
 TestPK1:
 	openssl req -x509 -sha256 -newkey rsa:2048 -subj /CN=ACS_TEST_PK/ -keyout $(TARGET)_$(@).key -out $(TARGET)_$(@).crt -nodes -days 4000
@@ -89,12 +114,12 @@ SignCert1:
 SignCert2:
 	openssl req -x509 -sha256 -newkey rsa:2048 -subj /CN=ACS_SignCert2/ -keyout $(TARGET)_$(@).key -out $(TARGET)_$(@).crt -nodes -days 4000
 
-Sign_Cert4:
-	openssl req -x509 -sha256 -newkey rsa:2048 -subj /CN=ACS_Sign_Cert3/ -keyout $(TARGET)_$(@).key -out $(TARGET)_$(@).crt -nodes -days 4000
-
 SignCert3:
 	openssl req -x509 -sha256 -newkey rsa:2048 -subj /CN=ACS_SignCert3/ -keyout $(TARGET)_$(@).key -out $(TARGET)_$(@).crt -nodes -days 4000
 
+SignCert4:
+	openssl req -x509 -sha256 -newkey rsa:2048 -subj /CN=ACS_SignCert4/ -keyout $(TARGET)_$(@).key -out $(TARGET)_$(@).crt -nodes -days 4000
+
 RevokedCert1:
 	openssl req -x509 -sha256 -newkey rsa:2048 -subj /CN=ACS_RevokedCert1/ -keyout $(TARGET)_$(@).key -out $(TARGET)_$(@).crt -nodes -days 4000
 
@@ -146,14 +171,14 @@ KEKSigList3.auth: TestKEK3
 	sign-efi-sig-list -c $(TEST_PK1_CRT) -k $(TEST_PK1_KEY) KEK $(BIN_DIR)/SecureBoot_KEKSigList1.esl $(BIN_DIR)/SecureBoot_KEKSigList1.auth
 
 dbSigListLong: SignCert2 SignCert3 RevokedCert1 RevokedCert2 RevokedCert3 RevokedCert4 TestImage5.bin
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_SignCert2.crt $(BIN_DIR)/SecureBoot_TestDB2.esl
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_SignCert3.crt $(BIN_DIR)/SecureBoot_TestDB3.esl
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert1.crt $(BIN_DIR)/SecureBoot_TestDB4.esl
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert2.crt $(BIN_DIR)/SecureBoot_TestDB5.esl
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert3.crt $(BIN_DIR)/SecureBoot_TestDB6.esl
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert4.crt $(BIN_DIR)/SecureBoot_TestDB7.esl
-	hash-to-efi-sig-list $(BIN_DIR)/SecureBoot_TestImage5.bin $(BIN_DIR)/SecureBoot_TestDB8.esl
-	cat $(BIN_DIR)/SecureBoot_TestDB2.esl $(BIN_DIR)/SecureBoot_TestDB3.esl $(BIN_DIR)/SecureBoot_TestDB4.esl $(BIN_DIR)/SecureBoot_TestDB5.esl $(BIN_DIR)/SecureBoot_TestDB6.esl  $(BIN_DIR)/SecureBoot_TestDB7.esl $(BIN_DIR)/SecureBoot_TestDB8.esl  > $(BIN_DIR)/SecureBoot_DBSigListLong.esl
+	cert-to-efi-sig-list -g 11111111-2222-3333-4444-000000000002 $(BIN_DIR)/SecureBoot_SignCert2.crt $(BIN_DIR)/SecureBoot_TestDB2.esl
+	cert-to-efi-sig-list -g 11111111-2222-3333-4444-000000000003 $(BIN_DIR)/SecureBoot_SignCert3.crt $(BIN_DIR)/SecureBoot_TestDB3.esl
+	cert-to-efi-sig-list -g 11111111-2222-3333-4444-0000000000C1 $(BIN_DIR)/SecureBoot_RevokedCert1.crt $(BIN_DIR)/SecureBoot_TestDB4.esl
+	cert-to-efi-sig-list -g 11111111-2222-3333-4444-0000000000C2 $(BIN_DIR)/SecureBoot_RevokedCert2.crt $(BIN_DIR)/SecureBoot_TestDB5.esl
+	cert-to-efi-sig-list -g 11111111-2222-3333-4444-0000000000C3 $(BIN_DIR)/SecureBoot_RevokedCert3.crt $(BIN_DIR)/SecureBoot_TestDB6.esl
+	cert-to-efi-sig-list -g 11111111-2222-3333-4444-0000000000C4 $(BIN_DIR)/SecureBoot_RevokedCert4.crt $(BIN_DIR)/SecureBoot_TestDB7.esl
+	hash-to-efi-sig-list $(BIN_DIR)/SecureBoot_TestImage5.bin $(BIN_DIR)/SecureBoot_Hash1.esl
+	cat $(BIN_DIR)/SecureBoot_TestDB2.esl $(BIN_DIR)/SecureBoot_TestDB3.esl $(BIN_DIR)/SecureBoot_TestDB4.esl $(BIN_DIR)/SecureBoot_TestDB5.esl $(BIN_DIR)/SecureBoot_TestDB6.esl  $(BIN_DIR)/SecureBoot_TestDB7.esl $(BIN_DIR)/SecureBoot_Hash1.esl  > $(BIN_DIR)/SecureBoot_DBSigListLong.esl
 
 dbSigList2.auth: dbSigListLong
 	sign-efi-sig-list -c $(TEST_KEK1_CRT) -k $(TEST_KEK1_KEY) -t "$(FUTURE_DATE2)" db $(BIN_DIR)/SecureBoot_DBSigListLong.esl $(BIN_DIR)/SecureBoot_DBSigList2.auth
@@ -161,17 +186,17 @@ dbSigList2.auth: dbSigListLong
 dbSigList3.auth: dbSigListLong
 	sign-efi-sig-list -c $(TEST_KEK1_CRT) -k $(TEST_KEK1_KEY) -t "$(FUTURE_DATE2)" dbx $(BIN_DIR)/SecureBoot_DBSigListLong.esl $(BIN_DIR)/SecureBoot_DBSigList3.auth
 
-dbSigList4.auth: Sign_Cert4
-	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_Sign_Cert4.crt $(BIN_DIR)/SecureBoot_TestDB9.esl
+dbSigList4.auth: SignCert4
+	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_SignCert4.crt $(BIN_DIR)/SecureBoot_TestDB9.esl
 	sign-efi-sig-list -c $(BIN_DIR)/SecureBoot_TestKEK2.crt -k $(BIN_DIR)/SecureBoot_TestKEK2.key -t "$(FUTURE_DATE3)" db $(BIN_DIR)/SecureBoot_TestDB9.esl $(BIN_DIR)/SecureBoot_DBSigList4.auth
 
-DBXRevokedList1.auth: RevokedCert1 RevokedCert2 RevokedCert3 RevokedCert4 TestImage5.bin
+DBXRevokedList1.auth: RevokedCert1 RevokedCert2 RevokedCert3 RevokedCert4
 	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert1.crt $(BIN_DIR)/SecureBoot_RevokedCert1.esl
 	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert2.crt $(BIN_DIR)/SecureBoot_RevokedCert2.esl
 	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert3.crt $(BIN_DIR)/SecureBoot_RevokedCert3.esl
 	cert-to-efi-sig-list $(BIN_DIR)/SecureBoot_RevokedCert4.crt $(BIN_DIR)/SecureBoot_RevokedCert4.esl
-	hash-to-efi-sig-list $(BIN_DIR)/SecureBoot_TestImage5.bin $(BIN_DIR)/SecureBoot_TestImage5Hash.esl
-	cat $(BIN_DIR)/SecureBoot_RevokedCert1.esl $(BIN_DIR)/SecureBoot_RevokedCert2.esl $(BIN_DIR)/SecureBoot_RevokedCert3.esl  $(BIN_DIR)/SecureBoot_RevokedCert4.esl $(BIN_DIR)/SecureBoot_TestImage5Hash.esl  > $(BIN_DIR)/SecureBoot_DBXRevokedList1.esl
+	hash-to-efi-sig-list $(BIN_DIR)/SecureBoot_Unsigned_TestImage10.bin $(BIN_DIR)/SecureBoot_RevokedHash1.esl
+	cat $(BIN_DIR)/SecureBoot_RevokedCert1.esl $(BIN_DIR)/SecureBoot_RevokedCert2.esl $(BIN_DIR)/SecureBoot_RevokedCert3.esl  $(BIN_DIR)/SecureBoot_RevokedCert4.esl $(BIN_DIR)/SecureBoot_RevokedHash1.esl > $(BIN_DIR)/SecureBoot_DBXRevokedList1.esl
 	sign-efi-sig-list -c $(TEST_KEK1_CRT) -k $(TEST_KEK1_KEY) -t "$(FUTURE_DATE2)" dbx $(BIN_DIR)/SecureBoot_DBXRevokedList1.esl $(BIN_DIR)/SecureBoot_DBXRevokedList1.auth
 
 clean:
-- 
2.17.1

